WARNING:COMMIT_LOG_LONG_LINE: Possible unwrapped commit description (prefer a maximum 75 chars per line)
#24: 
This is a fairly naive implementation that uses the tlb management instructions

WARNING:SPDX_LICENSE_TAG: Missing or malformed SPDX-License-Identifier tag in line 1
#48: FILE: drivers/kvm/mmu.c:1:
+/*

The source file is missing or has an improper SPDX identifier tag.
The Linux kernel requires the precise SPDX identifier in all source files,
and it is thoroughly documented in the kernel docs.

See: https://www.kernel.org/doc/html/latest/process/license-rules.html

ERROR:MULTISTATEMENT_MACRO_USE_DO_WHILE: Macros starting with if should be enclosed by a do - while loop to avoid possible if/else logic defects
#75: FILE: drivers/kvm/mmu.c:28:
+#define ASSERT(x)							\
+	if (!(x)) {							\
+		printk(KERN_WARNING "assertion failed %s:%d: %s\n",	\
+		       __FILE__, __LINE__, #x);				\
+	}

Macros with multiple statements should be enclosed in a
do - while block.  Same should also be the case for macros
starting with `if` to avoid logic defects::

  #define macrofun(a, b, c)                 \
    do {                                    \
            if (a == 5)                     \
                    do_this(b, c);          \
    } while (0)

See: https://www.kernel.org/doc/html/latest/process/coding-style.html#macros-enums-and-rtl

WARNING:PREFER_PR_LEVEL: Prefer [subsystem eg: netdev]_warn([subsystem]dev, ... then dev_warn(dev, ... then pr_warn(...  to printk(KERN_WARNING ...
#77: FILE: drivers/kvm/mmu.c:30:
+		printk(KERN_WARNING "assertion failed %s:%d: %s\n",	\

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#86: FILE: drivers/kvm/mmu.c:39:
+#define PT_PRESENT_MASK (1ULL << 0)

Defines like: 1 << <digit> could be BIT(digit).
The BIT() macro is defined via include/linux/bits.h::

  #define BIT(nr)         (1UL << (nr))

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#87: FILE: drivers/kvm/mmu.c:40:
+#define PT_WRITABLE_MASK (1ULL << PT_WRITABLE_SHIFT)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#88: FILE: drivers/kvm/mmu.c:41:
+#define PT_USER_MASK (1ULL << 2)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#89: FILE: drivers/kvm/mmu.c:42:
+#define PT_PWT_MASK (1ULL << 3)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#90: FILE: drivers/kvm/mmu.c:43:
+#define PT_PCD_MASK (1ULL << 4)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#91: FILE: drivers/kvm/mmu.c:44:
+#define PT_ACCESSED_MASK (1ULL << 5)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#92: FILE: drivers/kvm/mmu.c:45:
+#define PT_DIRTY_MASK (1ULL << 6)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#93: FILE: drivers/kvm/mmu.c:46:
+#define PT_PAGE_SIZE_MASK (1ULL << 7)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#94: FILE: drivers/kvm/mmu.c:47:
+#define PT_PAT_MASK (1ULL << 7)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#95: FILE: drivers/kvm/mmu.c:48:
+#define PT_GLOBAL_MASK (1ULL << 8)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#96: FILE: drivers/kvm/mmu.c:49:
+#define PT64_NX_MASK (1ULL << 63)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#100: FILE: drivers/kvm/mmu.c:53:
+#define PT_DIR_PAT_MASK (1ULL << PT_DIR_PAT_SHIFT)

CHECK:LINE_SPACING: Please don't use multiple blank lines
#106: FILE: drivers/kvm/mmu.c:59:
+
+

Vertical space is wasted given the limited number of lines an
editor window can display when multiple blank lines are used.

See: https://www.kernel.org/doc/html/latest/process/coding-style.html#spaces

ERROR:SPACING: space prohibited before that close parenthesis ')'
#110: FILE: drivers/kvm/mmu.c:63:
+	PT_GLOBAL_MASK )

Whitespace style used in the kernel sources is described in kernel docs.

See: https://www.kernel.org/doc/html/latest/process/coding-style.html#spaces

CHECK:LINE_SPACING: Please don't use multiple blank lines
#116: FILE: drivers/kvm/mmu.c:69:
+
+

CHECK:LINE_SPACING: Please don't use multiple blank lines
#123: FILE: drivers/kvm/mmu.c:76:
+
+

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#128: FILE: drivers/kvm/mmu.c:81:
+#define PT_SHADOW_PS_MARK (1ULL << PT_FIRST_AVAIL_BITS_SHIFT)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#129: FILE: drivers/kvm/mmu.c:82:
+#define PT_SHADOW_IO_MARK (1ULL << PT_FIRST_AVAIL_BITS_SHIFT)

CHECK:BIT_MACRO: Prefer using the BIT_ULL macro
#132: FILE: drivers/kvm/mmu.c:85:
+#define PT_SHADOW_WRITABLE_MASK (1ULL << PT_SHADOW_WRITABLE_SHIFT)

CHECK:MACRO_ARG_PRECEDENCE: Macro argument 'level' may be better as '(level)' to avoid precedence issues
#143: FILE: drivers/kvm/mmu.c:96:
+#define PT64_LEVEL_SHIFT(level) \
+		( PAGE_SHIFT + (level - 1) * PT64_LEVEL_BITS )

ERROR:SPACING: space prohibited after that open parenthesis '('
#144: FILE: drivers/kvm/mmu.c:97:
+		( PAGE_SHIFT + (level - 1) * PT64_LEVEL_BITS )

ERROR:SPACING: space prohibited before that close parenthesis ')'
#144: FILE: drivers/kvm/mmu.c:97:
+		( PAGE_SHIFT + (level - 1) * PT64_LEVEL_BITS )

CHECK:LINE_SPACING: Please don't use multiple blank lines
#152: FILE: drivers/kvm/mmu.c:105:
+
+

CHECK:MACRO_ARG_PRECEDENCE: Macro argument 'level' may be better as '(level)' to avoid precedence issues
#155: FILE: drivers/kvm/mmu.c:108:
+#define PT32_LEVEL_SHIFT(level) \
+		( PAGE_SHIFT + (level - 1) * PT32_LEVEL_BITS )

ERROR:SPACING: space prohibited after that open parenthesis '('
#156: FILE: drivers/kvm/mmu.c:109:
+		( PAGE_SHIFT + (level - 1) * PT32_LEVEL_BITS )

ERROR:SPACING: space prohibited before that close parenthesis ')'
#156: FILE: drivers/kvm/mmu.c:109:
+		( PAGE_SHIFT + (level - 1) * PT32_LEVEL_BITS )

CHECK:LINE_SPACING: Please don't use multiple blank lines
#164: FILE: drivers/kvm/mmu.c:117:
+
+

CHECK:LINE_SPACING: Please don't use multiple blank lines
#173: FILE: drivers/kvm/mmu.c:126:
+
+

CHECK:BIT_MACRO: Prefer using the BIT macro
#174: FILE: drivers/kvm/mmu.c:127:
+#define PFERR_PRESENT_MASK (1U << 0)

CHECK:BIT_MACRO: Prefer using the BIT macro
#175: FILE: drivers/kvm/mmu.c:128:
+#define PFERR_WRITE_MASK (1U << 1)

CHECK:BIT_MACRO: Prefer using the BIT macro
#176: FILE: drivers/kvm/mmu.c:129:
+#define PFERR_USER_MASK (1U << 2)

WARNING:LINE_SPACING: Missing a blank line after declarations
#223: FILE: drivers/kvm/mmu.c:176:
+	u32 *end;
+	for (pos = __va(page_hpa), end = pos + PAGE_SIZE / sizeof(u32);

ERROR:SPACING: spaces required around that ':' (ctx:VxW)
#259: FILE: drivers/kvm/mmu.c:212:
+	return is_error_hpa(hpa) ? bad_page_address | (gpa & ~PAGE_MASK): hpa;
 	                                                                ^

CHECK:SPACING: spaces preferred around that '-' (ctx:VxV)
#273: FILE: drivers/kvm/mmu.c:226:
+		| (gpa & (PAGE_SIZE-1));
 		                   ^

CHECK:LINE_SPACING: Please don't use multiple blank lines
#285: FILE: drivers/kvm/mmu.c:238:
+
+

CHECK:BRACES: braces {} should be used on all arms of this statement
#293: FILE: drivers/kvm/mmu.c:246:
+	if (level == 1)
[...]
+	else {
[...]

The placement of braces is stylistically incorrect.
The preferred way is to put the opening brace last on the line,
and put the closing brace first::

  if (x is true) {
          we do y
  }

This applies for all non-functional blocks.
However, there is one special case, namely functions: they have the
opening brace at the beginning of the next line, thus::

  int function(int x)
  {
          body of function
  }

See: https://www.kernel.org/doc/html/latest/process/coding-style.html#placing-braces-and-spaces

CHECK:BRACES: Unbalanced braces around else statement
#295: FILE: drivers/kvm/mmu.c:248:
+	else {

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#306: FILE: drivers/kvm/mmu.c:259:
+				release_pt_page_64(vcpu,
+						  current_ent &

WARNING:EMBEDDED_FUNCTION_NAME: Prefer using '"%s...", __func__' to using 'nonpaging_map', this function's name, in a string
#343: FILE: drivers/kvm/mmu.c:296:
+				pgprintk("nonpaging_map: ENOMEM\n");

Embedded function names are less appropriate to use as
refactoring can cause function renaming.  Prefer the use of
"%s", __func__ to embedded function names.

Note that this does not work with -f (--file) checkpatch option
as it depends on patch context providing the function name.

WARNING:EMBEDDED_FUNCTION_NAME: Prefer using '"%s...", __func__' to using 'nonpaging_flush', this function's name, in a string
#362: FILE: drivers/kvm/mmu.c:315:
+	pgprintk("nonpaging_flush\n");

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#379: FILE: drivers/kvm/mmu.c:332:
+static int nonpaging_page_fault(struct kvm_vcpu *vcpu, gva_t gva,
+			       u32 error_code)

WARNING:SUSPECT_CODE_INDENT: suspect code indent for conditional statements (8, 13)
#387: FILE: drivers/kvm/mmu.c:340:
+	for (;;) {
+	     hpa_t paddr;

WARNING:TABSTOP: Statements should start on a tabstop
#388: FILE: drivers/kvm/mmu.c:341:
+	     hpa_t paddr;

ERROR:SPACING: space prohibited before that ',' (ctx:WxW)
#390: FILE: drivers/kvm/mmu.c:343:
+	     paddr = gpa_to_hpa(vcpu , addr & PT64_BASE_ADDR_MASK);
 	                             ^

WARNING:TABSTOP: Statements should start on a tabstop
#392: FILE: drivers/kvm/mmu.c:345:
+	     if (is_error_hpa(paddr))

WARNING:SUSPECT_CODE_INDENT: suspect code indent for conditional statements (13, 21)
#392: FILE: drivers/kvm/mmu.c:345:
+	     if (is_error_hpa(paddr))
+		     return 1;

WARNING:TABSTOP: Statements should start on a tabstop
#393: FILE: drivers/kvm/mmu.c:346:
+		     return 1;

WARNING:TABSTOP: Statements should start on a tabstop
#396: FILE: drivers/kvm/mmu.c:349:
+	     if (ret) {

WARNING:SUSPECT_CODE_INDENT: suspect code indent for conditional statements (13, 21)
#396: FILE: drivers/kvm/mmu.c:349:
+	     if (ret) {
+		     nonpaging_flush(vcpu);

WARNING:TABSTOP: Statements should start on a tabstop
#398: FILE: drivers/kvm/mmu.c:351:
+		     continue;

WARNING:TABSTOP: Statements should start on a tabstop
#399: FILE: drivers/kvm/mmu.c:352:
+	     }

WARNING:TABSTOP: Statements should start on a tabstop
#400: FILE: drivers/kvm/mmu.c:353:
+	     break;

CHECK:LINE_SPACING: Please don't use multiple blank lines
#437: FILE: drivers/kvm/mmu.c:390:
+
+

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#467: FILE: drivers/kvm/mmu.c:420:
+static inline void set_pte_common(struct kvm_vcpu *vcpu,
+			     u64 *shadow_pte,

WARNING:EMBEDDED_FUNCTION_NAME: Prefer using '"%s...", __func__' to using 'inject_page_fault', this function's name, in a string
#504: FILE: drivers/kvm/mmu.c:457:
+	pgprintk("inject_page_fault: 0x%llx err 0x%x\n", addr, err_code);

WARNING:PREFER_PR_LEVEL: Prefer [subsystem eg: netdev]_dbg([subsystem]dev, ... then dev_dbg(dev, ... then pr_debug(...  to printk(KERN_DEBUG ...
#509: FILE: drivers/kvm/mmu.c:462:
+		printk(KERN_DEBUG "inject_page_fault: "

WARNING:EMBEDDED_FUNCTION_NAME: Prefer using '"%s...", __func__' to using 'inject_page_fault', this function's name, in a string
#509: FILE: drivers/kvm/mmu.c:462:
+		printk(KERN_DEBUG "inject_page_fault: "

WARNING:SPLIT_STRING: quoted string split across lines
#510: FILE: drivers/kvm/mmu.c:463:
+		printk(KERN_DEBUG "inject_page_fault: "
+		       "double fault 0x%llx @ 0x%lx\n",

Quoted strings that appear as messages in userspace and can be
grepped, should not be split across multiple lines.

See: https://lore.kernel.org/lkml/20120203052727.GA15035@leaf/

CHECK:BRACES: Blank lines aren't necessary before a close brace '}'
#528: FILE: drivers/kvm/mmu.c:481:
+
+}

CHECK:BRACES: Blank lines aren't necessary before a close brace '}'
#543: FILE: drivers/kvm/mmu.c:496:
+
+	}

CHECK:BRACES: Blank lines aren't necessary after an open brace '{'
#549: FILE: drivers/kvm/mmu.c:502:
+{
+

ERROR:SPACING: space prohibited before that close parenthesis ')'
#571: FILE: drivers/kvm/mmu.c:524:
+		if (level == PT_PAGE_TABLE_LEVEL ) {

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#582: FILE: drivers/kvm/mmu.c:535:
+		if (level == PT_DIRECTORY_LEVEL &&
+			  (table[index] & PT_SHADOW_PS_MARK)) {

ERROR:ASSIGN_IN_IF: do not use assignment in if condition
#648: FILE: drivers/kvm/mmu.c:601:
+	if ((ret = paging64_init_context(vcpu)))

Do not use assignments in if condition.
Example::

  if ((foo = bar(...)) < BAZ) {

should be written as::

  foo = bar(...);
  if (foo < BAZ) {

ERROR:ASSIGN_IN_IF: do not use assignment in if condition
#710: FILE: drivers/kvm/mmu.c:663:
+		if ((page = alloc_page(GFP_KVM_MMU)) == NULL)

ERROR:ASSIGN_IN_IF: do not use assignment in if condition
#732: FILE: drivers/kvm/mmu.c:685:
+	if ((r = alloc_mmu_pages(vcpu)))

ERROR:ASSIGN_IN_IF: do not use assignment in if condition
#735: FILE: drivers/kvm/mmu.c:688:
+	if ((r = init_kvm_mmu(vcpu))) {

CHECK:BRACES: Blank lines aren't necessary before a close brace '}'
#767: FILE: drivers/kvm/mmu.c:720:
+
+	}

WARNING:SPDX_LICENSE_TAG: Missing or malformed SPDX-License-Identifier tag in line 1
#774: FILE: drivers/kvm/paging_tmpl.h:1:
+/*

ERROR:COMPLEX_MACRO: Macros with complex values should be enclosed in parentheses
#782: FILE: drivers/kvm/paging_tmpl.h:9:
+	#define FNAME(name) paging##64_##name

ERROR:COMPLEX_MACRO: Macros with complex values should be enclosed in parentheses
#793: FILE: drivers/kvm/paging_tmpl.h:20:
+	#define FNAME(name) paging##32_##name

ERROR:SPACING: space prohibited after that open parenthesis '('
#830: FILE: drivers/kvm/paging_tmpl.h:57:
+	walker->table = (pt_element_t *)( (unsigned long)walker->table |

ERROR:SPACING: space prohibited before that close parenthesis ')'
#831: FILE: drivers/kvm/paging_tmpl.h:58:
+		(unsigned long)(vcpu->cr3 & ~(PAGE_MASK | CR3_FLAGS_MASK)) );

ERROR:CODE_INDENT: code indent should use tabs where possible
#863: FILE: drivers/kvm/paging_tmpl.h:90:
+^I^I          ((guest_pde & PT_DIR_PAT_MASK) >>$

Code indent should use tabs instead of spaces.
Outside of comments, documentation and Kconfig,
spaces are never used for indentation.

See: https://www.kernel.org/doc/html/latest/process/coding-style.html#indentation

ERROR:CODE_INDENT: code indent should use tabs where possible
#864: FILE: drivers/kvm/paging_tmpl.h:91:
+^I^I^I            (PT_DIR_PAT_SHIFT - PT_PAT_SHIFT));$

CHECK:BRACES: Blank lines aren't necessary after an open brace '{'
#877: FILE: drivers/kvm/paging_tmpl.h:104:
+{
+

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#906: FILE: drivers/kvm/paging_tmpl.h:133:
+static u64 *FNAME(fetch)(struct kvm_vcpu *vcpu, gva_t addr,
+			      struct guest_walker *walker)

CHECK:BRACES: Unbalanced braces around else statement
#932: FILE: drivers/kvm/paging_tmpl.h:159:
+		} else

CHECK:BRACES: Blank lines aren't necessary after an open brace '{'
#944: FILE: drivers/kvm/paging_tmpl.h:171:
+		if (level == PT_PAGE_TABLE_LEVEL) {
+

ERROR:CODE_INDENT: code indent should use tabs where possible
#950: FILE: drivers/kvm/paging_tmpl.h:177:
+^I^I^I^I          PT_INDEX(addr, PT_PAGE_TABLE_LEVEL));$

CHECK:BRACES: Unbalanced braces around else statement
#964: FILE: drivers/kvm/paging_tmpl.h:191:
+		else {

CHECK:BRACES: Unbalanced braces around else statement
#1002: FILE: drivers/kvm/paging_tmpl.h:229:
+	} else

CHECK:PARENTHESIS_ALIGNMENT: Alignment should match open parenthesis
#1042: FILE: drivers/kvm/paging_tmpl.h:269:
+static int FNAME(page_fault)(struct kvm_vcpu *vcpu, gva_t addr,
+			       u32 error_code)

WARNING:USE_FUNC: __func__ should be used instead of gcc specific __FUNCTION__
#1091: FILE: drivers/kvm/paging_tmpl.h:318:
+		pgprintk("%s: io work, no access\n", __FUNCTION__);

/tmp/tmp.gGZ8aIRHtl//home/kkleine/dev/lkml/0/patch.offset.24269.commit.7a5f655fa57da74d4852f70cbb76264b5b32dab1 total: 20 errors, 22 warnings, 46 checks, 1118 lines checked

NOTE: For some of the reported defects, checkpatch may be able to
      mechanically convert to the typical style using --fix or --fix-inplace.

NOTE: Whitespace errors detected.
      You may wish to use scripts/cleanpatch or scripts/cleanfile

/tmp/tmp.gGZ8aIRHtl//home/kkleine/dev/lkml/0/patch.offset.24269.commit.7a5f655fa57da74d4852f70cbb76264b5b32dab1 has style problems, please review.

NOTE: If any of the errors are false positives, please report
      them to the maintainer, see CHECKPATCH in MAINTAINERS.
